name: ğŸ”„ Auto Backup - Source to Backup

on:
  # DÃ©clencheurs
  push:
    paths:
      - 'Source/**'  # Se dÃ©clenche seulement si Source change
    branches: [ main ]
  
  pull_request:
    branches: [ main ]
  
  schedule:
    # Backup automatique tous les jours Ã  minuit (UTC)
    - cron: '0 0 * * *'
  
  workflow_dispatch:  # Permet de lancer manuellement

env:
  SOURCE_DIR: 'Source'
  BACKUP_DIR: 'Backup'

jobs:
  synchronisation:
    name: ğŸ”„ Synchronisation Source â†’ Backup
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      # Ã‰tape 1: RÃ©cupÃ©ration du code
      - name: ğŸ“¥ Checkout du repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # RÃ©cupÃ¨re tout l'historique
      
      # Ã‰tape 2: Configuration Git
      - name: âš™ï¸ Configuration Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "âœ… Git configurÃ©"
      
      # Ã‰tape 3: Synchronisation des fichiers
      - name: ğŸ“‚ Synchronisation Source â†’ Backup
        run: |
          echo "ğŸ”„ DÃ©but de la synchronisation..."
          echo "Dossier Source: $SOURCE_DIR"
          echo "Dossier Backup: $BACKUP_DIR"
          
          # VÃ©rifier si Source existe
          if [ ! -d "$SOURCE_DIR" ]; then
            echo "âŒ Le dossier $SOURCE_DIR n'existe pas"
            exit 1
          fi
          
          # Nettoyer le Backup existant
          if [ -d "$BACKUP_DIR" ]; then
            rm -rf "$BACKUP_DIR"/*
            echo "ğŸ§¹ Backup prÃ©cÃ©dent nettoyÃ©"
          else
            mkdir -p "$BACKUP_DIR"
            echo "ğŸ“ Dossier Backup crÃ©Ã©"
          fi
          
          # Copier rÃ©cursivement le contenu
          cp -r "$SOURCE_DIR"/* "$BACKUP_DIR"/ 2>/dev/null || true
          
          # VÃ©rification
          echo "âœ… Synchronisation terminÃ©e"
          echo "ğŸ“Š Contenu de Backup:"
          ls -la "$BACKUP_DIR"/
          echo "ğŸ“Š Contenu de Source:"
          ls -la "$SOURCE_DIR"/
      
      # Ã‰tape 4: VÃ©rification des changements
      - name: ğŸ” VÃ©rification des modifications
        id: check_changes
        run: |
          git add "$BACKUP_DIR"/
          if git diff --staged --quiet; then
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "ğŸ”µ Aucun changement dÃ©tectÃ©"
          else
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¢ Changements dÃ©tectÃ©s - Commit nÃ©cessaire"
            echo "ğŸ“ Fichiers modifiÃ©s:"
            git diff --staged --name-only
          fi
      
      # Ã‰tape 5: Commit et Push
      - name: ğŸ“ Commit et Push des changements
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          # CrÃ©er le message de commit avec date
          COMMIT_MSG="ğŸ¤– Auto-Backup: $(date +'%Y-%m-%d %H:%M:%S')"
          
          git commit -m "$COMMIT_MSG"
          git push
          echo "âœ… Backup poussÃ© avec succÃ¨s!"
          echo "ğŸ“‹ Commit: $COMMIT_MSG"
      
      # Ã‰tape 6: Rapport final
      - name: ğŸ“Š Rapport de synchronisation
        run: |
          echo "ğŸ‰ SYNCHRONISATION TERMINÃ‰E"
          echo "================================"
          echo "ğŸ• Heure: $(date)"
          echo "ğŸ“ Source: $SOURCE_DIR"
          echo "ğŸ“ Backup: $BACKUP_DIR"
          echo "ğŸ”„ Changements: ${{ steps.check_changes.outputs.changes_detected }}"
          echo "================================"
