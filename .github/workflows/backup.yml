name: ğŸ”„ Backup System UnifiÃ©

on:
  push:
    paths:
      - 'Source/**'
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Tous les jours Ã  2h UTC
  workflow_dispatch:

env:
  SOURCE_DIR: 'Source'
  BACKUP_DIR: 'Backup'
  ARCHIVE_DIR: 'Archives'

jobs:
  unified-backup:
    name: ğŸ“¦ Backup & Archives UnifiÃ©s
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    # Ã‰tape 1: Initialisation
    - name: ğŸ“¥ Checkout et configuration
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: âš™ï¸ Configuration initiale
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        mkdir -p $ARCHIVE_DIR
        
        # Variables pour la session
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        SESSION_ID="backup_${TIMESTAMP}"
        echo "SESSION_ID=$SESSION_ID" >> $GITHUB_ENV
        
        # Fichier de log principal dans Archives
        LOG_FILE="$ARCHIVE_DIR/${SESSION_ID}.log"
        echo "LOG_FILE=$LOG_FILE" >> $GITHUB_ENV
        
        # DÃ©but du log
        echo "ğŸŸ¢ DEBUT SESSION BACKUP - $TIMESTAMP" > $LOG_FILE
        echo "======================================" >> $LOG_FILE
        echo "DÃ©clencheur: ${{ github.event_name }}" >> $LOG_FILE
        echo "Branche: ${{ github.ref }}" >> $LOG_FILE
        echo "Commit: ${{ github.sha }}" >> $LOG_FILE
        echo "Source: $SOURCE_DIR" >> $LOG_FILE
        echo "Backup: $BACKUP_DIR" >> $LOG_FILE
        echo "Archives: $ARCHIVE_DIR" >> $LOG_FILE
        echo "Session: $SESSION_ID" >> $LOG_FILE
        echo "======================================" >> $LOG_FILE

    # Ã‰tape 2: Audit prÃ©-backup
    - name: ğŸ” Audit des fichiers sources
      run: |
        echo "" >> $LOG_FILE
        echo "ğŸ“Š AUDIT PRE-BACKUP" >> $LOG_FILE
        echo "-------------------" >> $LOG_FILE
        
        if [ -d "$SOURCE_DIR" ] && [ "$(ls -A $SOURCE_DIR 2>/dev/null)" ]; then
          echo "ğŸ“ Contenu de $SOURCE_DIR:" >> $LOG_FILE
          find $SOURCE_DIR -type f -exec ls -la {} \; >> $LOG_FILE 2>/dev/null || echo "Aucun fichier accessible" >> $LOG_FILE
          SOURCE_COUNT=$(find $SOURCE_DIR -type f | wc -l)
          echo "âœ… Total fichiers sources: $SOURCE_COUNT" >> $LOG_FILE
        else
          echo "âš ï¸ Dossier Source vide ou inaccessible" >> $LOG_FILE
          SOURCE_COUNT=0
        fi
        echo "SOURCE_COUNT=$SOURCE_COUNT" >> $GITHUB_ENV

    # Ã‰tape 3: Archivage du backup existant
    - name: ğŸ—‚ï¸ Archivage du backup prÃ©cÃ©dent
      run: |
        echo "" >> $LOG_FILE
        echo "ğŸ“¦ ARCHIVAGE BACKUP EXISTANT" >> $LOG_FILE
        echo "----------------------------" >> $LOG_FILE
        
        if [ -d "$BACKUP_DIR" ] && [ "$(ls -A $BACKUP_DIR 2>/dev/null)" ]; then
          ARCHIVE_NAME="${SESSION_ID}_previous.tar.gz"
          tar -czf "$ARCHIVE_DIR/$ARCHIVE_NAME" "$BACKUP_DIR"/
          
          echo "âœ… Archive crÃ©Ã©e: $ARCHIVE_NAME" >> $LOG_FILE
          echo "ğŸ“‹ Contenu archivÃ©:" >> $LOG_FILE
          tar -tzf "$ARCHIVE_DIR/$ARCHIVE_NAME" | head -20 >> $LOG_FILE
          echo "[...]" >> $LOG_FILE
          
          PREVIOUS_COUNT=$(tar -tzf "$ARCHIVE_DIR/$ARCHIVE_NAME" | grep -v "/$" | wc -l)
          echo "ğŸ“Š Fichiers archivÃ©s: $PREVIOUS_COUNT" >> $LOG_FILE
        else
          echo "â„¹ï¸ Aucun backup prÃ©cÃ©dent Ã  archiver" >> $LOG_FILE
          PREVIOUS_COUNT=0
        fi
        echo "PREVIOUS_COUNT=$PREVIOUS_COUNT" >> $GITHUB_ENV

    # Ã‰tape 4: Synchronisation
    - name: ğŸ”„ Synchronisation Source â†’ Backup
      run: |
        echo "" >> $LOG_FILE
        echo "ğŸ”„ SYNCHRONISATION" >> $LOG_FILE
        echo "------------------" >> $LOG_FILE
        
        # Nettoyage complet
        rm -rf $BACKUP_DIR
        mkdir -p $BACKUP_DIR
        
        if [ $SOURCE_COUNT -gt 0 ]; then
          # Copie avec prÃ©servation des permissions
          cp -r $SOURCE_DIR/* $BACKUP_DIR/ 2>&1 >> $LOG_FILE || echo "âš ï¸ Erreurs lors de la copie" >> $LOG_FILE
          
          echo "âœ… Synchronisation terminÃ©e" >> $LOG_FILE
          echo "ğŸ“ Contenu de $BACKUP_DIR:" >> $LOG_FILE
          find $BACKUP_DIR -type f -exec ls -la {} \; >> $LOG_FILE 2>/dev/null
          
          BACKUP_COUNT=$(find $BACKUP_DIR -type f | wc -l)
          echo "ğŸ“Š Fichiers dans Backup: $BACKUP_COUNT" >> $LOG_FILE
        else
          echo "â­ï¸ Aucun fichier source, synchronisation ignorÃ©e" >> $LOG_FILE
          BACKUP_COUNT=0
        fi
        echo "BACKUP_COUNT=$BACKUP_COUNT" >> $GITHUB_ENV

    # Ã‰tape 5: CrÃ©ation du rapport de session
    - name: ğŸ“ˆ GÃ©nÃ©ration du rapport final
      run: |
        echo "" >> $LOG_FILE
        echo "ğŸ“ˆ RAPPORT DE SESSION" >> $LOG_FILE
        echo "=====================" >> $LOG_FILE
        echo "ğŸ• DÃ©but: $(date -d @$(echo $SESSION_ID | cut -d'_' -f2 | cut -c1-8))" >> $LOG_FILE
        echo "â±ï¸ Fin: $(date)" >> $LOG_FILE
        echo "ğŸ“ Fichiers sources: $SOURCE_COUNT" >> $LOG_FILE
        echo "ğŸ“ Fichiers backup: $BACKUP_COUNT" >> $LOG_FILE
        echo "ğŸ“¦ Fichiers archivÃ©s: $PREVIOUS_COUNT" >> $LOG_FILE
        echo "ğŸ“Š Taux de rÃ©ussite: $(( BACKUP_COUNT * 100 / (SOURCE_COUNT + 1) ))%" >> $LOG_FILE
        echo "ğŸ¯ Statut: $([ $BACKUP_COUNT -eq $SOURCE_COUNT ] && echo 'SUCCÃˆS' || echo 'ATTENTION')" >> $LOG_FILE
        echo "ğŸ”š FIN SESSION - $(date +%Y%m%d_%H%M%S)" >> $LOG_FILE

    # Ã‰tape 6: Nettoyage et optimisation
    - name: ğŸ§¹ Gestion des archives
      run: |
        echo "" >> $LOG_FILE
        echo "ğŸ§¹ GESTION DU STOCKAGE" >> $LOG_FILE
        echo "---------------------" >> $LOG_FILE
        
        # Compter les archives avant nettoyage
        ARCHIVE_TOTAL=$(find $ARCHIVE_DIR -name "*.tar.gz" | wc -l)
        LOG_TOTAL=$(find $ARCHIVE_DIR -name "*.log" | wc -l)
        
        echo "ğŸ“¦ Archives avant nettoyage: $ARCHIVE_TOTAL" >> $LOG_FILE
        echo "ğŸ“ Logs avant nettoyage: $LOG_TOTAL" >> $LOG_FILE
        
        # Garder seulement les 15 derniÃ¨res archives + logs
        if [ $ARCHIVE_TOTAL -gt 15 ]; then
          echo "ğŸ—‘ï¸ Nettoyage des anciennes archives..." >> $LOG_FILE
          find $ARCHIVE_DIR -name "*.tar.gz" -type f | sort | head -n -15 | while read file; do
            echo "  SupprimÃ©: $(basename $file)" >> $LOG_FILE
            rm "$file"
          done
        fi
        
        if [ $LOG_TOTAL -gt 15 ]; then
          echo "ğŸ—‘ï¸ Nettoyage des anciens logs..." >> $LOG_FILE
          find $ARCHIVE_DIR -name "*.log" -type f | sort | head -n -15 | while read file; do
            echo "  SupprimÃ©: $(basename $file)" >> $LOG_FILE
            rm "$file"
          done
        fi
        
        echo "âœ… Nettoyage terminÃ©" >> $LOG_FILE
        echo "ğŸ“¦ Archives restantes: $(find $ARCHIVE_DIR -name "*.tar.gz" | wc -l)" >> $LOG_FILE
        echo "ğŸ“ Logs restants: $(find $ARCHIVE_DIR -name "*.log" | wc -l)" >> $LOG_FILE

    # Ã‰tape 7: Commit unifiÃ©
    - name: ğŸ’¾ Commit des changements
      run: |
        echo "" >> $LOG_FILE
        echo "ğŸ’¾ COMMIT AUTOMATIQUE" >> $LOG_FILE
        echo "---------------------" >> $LOG_FILE
        
        git add $BACKUP_DIR/ $ARCHIVE_DIR/
        
        if git diff --staged --quiet; then
          echo "ğŸ”µ Aucun changement dÃ©tectÃ©" >> $LOG_FILE
          echo "â­ï¸ Commit ignorÃ©" >> $LOG_FILE
        else
          COMMIT_MSG="ğŸ¤– Backup System: $SESSION_ID - S:$SOURCE_COUNT B:$BACKUP_COUNT A:$PREVIOUS_COUNT"
          git commit -m "$COMMIT_MSG"
          git push
          echo "âœ… Commit effectuÃ©: $COMMIT_MSG" >> $LOG_FILE
          echo "ğŸ“¤ Changements poussÃ©s sur ${{ github.ref }}" >> $LOG_FILE
        fi

    # Ã‰tape 8: RÃ©sumÃ© console
    - name: ğŸ¯ RÃ©sumÃ© d'exÃ©cution
      run: |
        echo "=========================================="
        echo "ğŸ‰ BACKUP UNIFIÃ‰ TERMINÃ‰ - $SESSION_ID"
        echo "=========================================="
        echo "ğŸ“ Source: $SOURCE_COUNT fichiers"
        echo "ğŸ“ Backup: $BACKUP_COUNT fichiers"
        echo "ğŸ“¦ Archives: $(find $ARCHIVE_DIR -name "*.tar.gz" | wc -l) fichiers"
        echo "ğŸ“ Logs: $(find $ARCHIVE_DIR -name "*.log" | wc -l) fichiers"
        echo "ğŸ“Š Rapport: $ARCHIVE_DIR/${SESSION_ID}.log"
        echo "ğŸ• DurÃ©e: $(date)"
        echo "=========================================="
        
        # Afficher les derniÃ¨res lignes du log
        echo "ğŸ“„ Extrait du log:"
        tail -10 $LOG_FILE
